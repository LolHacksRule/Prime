#include "SysFont.h"
#include "SexyAppBase.h"
#include "Graphics.h"
#include "ImageFont.h"
#include "MemoryImage.h"
#include <stdlib.h>
//Don't need DDImage D3DInterface and WidgetManager
static uint gs_font_char_width = 12;
static uint gs_font_char_height = 16;
static uchar gs_font_char_data[] = { 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x00, 0x08, 0x08, 0x00, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x03, 0x02, 0x04, 0x06, 0x06, 0x0A, 0x07, 0x02, 0x04, 0x04, 0x04, 0x06, 0x03, 0x04, 0x03, 0x03, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x03, 0x03, 0x06, 0x06, 0x06, 0x06, 0x0B, 0x08, 0x07, 0x07, 0x07, 0x06, 0x06, 0x08, 0x07, 0x02, 0x05, 0x07, 0x06, 0x08, 0x07, 0x08, 0x06, 0x08, 0x07, 0x07, 0x06, 0x07, 0x08, 0x0A, 0x07, 0x08, 0x07, 0x03, 0x03, 0x03, 0x05, 0x06, 0x04, 0x06, 0x06, 0x06, 0x06, 0x06, 0x04, 0x06, 0x06, 0x02, 0x02, 0x05, 0x02, 0x08, 0x06, 0x06, 0x06, 0x06, 0x04, 0x06, 0x03, 0x06, 0x06, 0x0A, 0x06, 0x06, 0x06, 0x04, 0x02, 0x04, 0x06, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x0B, 0x08, 0x08, 0x08 };
static uint gs_font_image_width_in_longs = gs_font_image_height / 16; //Or 16?
static uint gs_font_image_width = 192;
static uint gs_font_image_height = 256;
static ulong gs_font_image_data[] =
{ 
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1057222719,66076419,4030661616,1057222719,66076419,4030661616,553783329,34611458,270598672,553783329,34611458,270598672,553783329,34611458,270598672,553783329,34611458,270598672,553783329,34611458,270598672,553783329,34611458,270598672,553783329,34611458,270598672,553783329,34611458,270598672,553783329,34611458,270598672,553783329,34611458,270598672,1057222719,66076419,4030661616,1057222719,66076419,4030661616,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1057222719,66076419,4030661616,1057222719,66076419,4030661616,553783329,34611458,270598672,553783329,34611458,270598672,553783329,34611458,270598672,553783329,34611458,270598672,553783329,34611458,270598672,553783329,34611458,270598672,553783329,34611458,270598672,553783329,34611458,270598672,553783329,34611458,270598672,553783329,34611458,270598672,1057222719,66076419,4030661616,1057222719,66076419,4030661616,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,262224,20985859,270009344,268697632,0,256,262224,20993028,2686714880,537002096,0,256,262224,130043908,2686714880,1073807392,16777216,512,262144,41957379,1075314688,1073807440,16777216,512,262144,41948160,1479016448,1073807360,130023424,512,262144,130028544,2756050944,1073807360,16777223,512,0,83907584,2755919872,1073807360,16777216,1024,262144,83900417,406454272,1073807360,8192,2098176,0,4096,0,537001984,8192,0,0,0,0,268697600,8192,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,939589688,58722307,3224897472,939753472,0,896,1141047364,71309314,4456576,1141129216,0,1088,1141178372,4204548,4194432,1141129280,67109888,4194368,1140916228,25176071,2155348224,939802624,14343,3224895616,1140916232,4212736,1078198528,1141096448,16384,262400,1140916240,4226048,1078198784,1140867072,14343,3224895744,1140916256,71305220,1078198784,1141129216,1024,4194304,939589756,58722307,2151154176,939753536,67108864,256,0,0,0,0,67108864,0,0,0,0,0,67108864,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,260079740,29390855,3229352384,1107558408,69222404,272761280,809582658,35668996,4194848,1107558408,71319558,811729440,648101954,67125764,4195344,1107558408,75513862,810681360,1235304574,67125767,3229090816,2114191368,92291077,1347552272,1361190978,67125764,4195440,1107558408,109068293,1347027984,1361305666,67125764,4195344,1107558472,71319557,1347027984,1396969538,35668996,4194848,1107558472,71319556,2420507168,1300500604,29390855,3225420224,1107558448,69237764,2420244928,538968064,0,0,0,0,0,532676608,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2013380732,62946308,541132866,1107562558,100679686,1048576,1140990018,69210116,541132962,604119044,67125250,2621440,1141116994,67112964,539100324,604119048,67117058,2621440,1141117052,50335748,539100324,402735112,67117058,4456448,2013532232,12587012,538182932,402685968,67117058,0,1074057284,2101252,538182932,604012560,67117058,0,1073881156,69210116,537395720,604012576,67112962,0,1073860674,62918659,3221750280,1107329150,67112962,0,0,0,0,0,67108866,0,0,0,0,0,100663302,2016,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1073741888,1024,1048576,1074004032,67125248,0,536870976,1024,2097152,1073741824,67125248,0,229464,58733571,2154824512,1476657216,75513861,3765961600,278628,71322628,1075840192,1677983808,83902470,2420376640,245828,67126279,3223323712,1141112896,100679684,2420376640,278596,67126276,2098240,1141112896,83902468,2420376640,311396,71322628,1075840192,1141112896,83902468,2420376640,213080,58733571,2149581632,1141112896,75513860,2420376448,0,0,64,64,0,0,0,0,1920,128,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,16384,0,0,16793602,0,0,16384,0,0,33570817,1008,1476608080,58777604,1078199364,1141129340,33570817,528,1678032992,71319556,1078199460,671367176,33570817,7602704,1141129280,50348036,1076363944,268599312,67125248,2153251344,1141129280,8404996,1076363944,268599312,33570817,528,1678032960,71319556,3222274320,671154208,33570817,528,1476608064,58744835,1074790672,1140916348,33570817,1008,1073758208,0,0,65536,33570817,0,1073758208,0,0,131072,16793602,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,40,0,1310720,0,0,0,16,0,524288,0,0,0,0,0,0,503316480,12582912,1048832,268582972,15328,4063232,537128960,16777216,1048832,671432770,17923,4026794992,2114064384,58720256,8128448,344128,16898,268960272,537006080,16777216,1048832,163888,16794594,268960272,2114064384,16777216,1048832,41484,33571330,269484560,537006080,16777216,1048832,87298,67125762,269484560,268570624,33554432,1048832,87362,33572354,270533136,235139136,33574914,1209010112,74300,16792547,4034790384,64,33574912,1048832,0,0,0,64,100683776,1048832,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,320,0,0,0,40,0,2621440,262208,83906560,0,671564816,0,1049616,1057226816,83906560,0,1342336000,3,4026532384,553910336,83906567,0,158776,15234,276562464,553648128,7,0,152644,67126338,268960064,553648128,7,0,48,33572802,269484160,553648128,0,16650239,8,16794626,269484160,553648128,0,0,68,33571906,270532736,1056964608,0,0,56,67124099,4034658432,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2016,8,25165828,1077937024,1342300272,0,1966080,8,37765636,1077937216,135184,0,2162688,262200,33569794,2151678464,321648,0,6062080,84,33563650,2151679744,329840,21003264,5406720,262224,117449735,3221226624,337920,41944064,6062080,262224,33569793,576,313344,83887111,5406720,262228,50348551,3225420096,135168,41943040,2162688,262200,79691777,4194432,122880,20971520,1966080,262176,0,4195392,0,0,0,262176,0,4195200,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1879048304,117444608,4063232,65584,8449,141590528,1342242832,33562624,7602176,196680,25091,270598144,1879113760,16777220,1081344000,65608,9217,538050816,508016,117440516,1077149696,65584,83895297,1081212928,65536,4,1075053568,0,41945344,1543799040,65536,4,1075052544,0,20974336,2215215360,0,4,1075052544,0,41949057,135512576,507904,7,3222536192,0,83894529,470844416,0,4,1310720,536870912,0,1088,0,4,1310720,268435456,0,896,0,0,0,805306368,0,0,0,0,0,0,0,0,0,0,0,0,0,0,268451848,10485760,0,536903696,32770,4194304,134250516,20976641,3221225472,268501032,41959428,10488320,0,1,1073741824,0,0,0,134250504,8390657,3222266304,2080882812,130039812,4195328,335626260,20976641,1074397728,1074004032,67125252,4195328,335626260,20976641,1074922496,1074004032,67125252,4195328,335626260,20976641,1075045376,2080882812,130039812,4195328,570564642,35660290,539100160,1074004032,67125252,4195328,1040441406,65027587,3762160640,1074004032,67125252,4195328,1090785345,68174084,272761376,1074004032,67125252,4195328,1090785345,68174084,272884160,2080882812,130039812,4195328,0,0,128,0,0,0,0,0,64,0,0,0,0,0,192,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,81936,4196352,2684354560,65544,16777216,1073741824,163848,8393729,1075052544,32784,41948160,2147483648,0,0,0,0,0,0,1006903324,29367297,3223060480,486809666,69222916,272630656,570826786,35660290,539099136,587472962,69222914,541066304,553984065,68174084,272696384,1157898306,69222914,544998464,2030379073,68174084,272695936,1225007170,69222913,1078068352,553951297,68174084,272695552,1225007170,69222912,2151810240,553951297,68174084,272695936,1359224898,69222912,2155611168,570712098,35660290,539100224,570695746,69222912,2151679264,1006903324,29367297,3223060480,1543749692,62929920,2151679168,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,2147483648,0,0,0,268468240,20971522,2147483648,536903696,32770,2097152,134283304,41953283,2147483648,268501032,41959428,5245440,0,0,0,0,0,0,939753528,58734595,2151383936,939753528,58736644,4195328,1141129284,71320580,1078215744,1141129284,71319556,4195328,1006878780,62929923,3225404416,2080882812,130039812,4195328,1141129284,71320580,1078199296,1074004032,67125252,4195328,1275379788,79711236,3225699392,1141129284,71319556,4195328,872628276,54539267,1077642112,939753528,58736644,4195328,0,0,256,0,0,0,0,0,128,0,0,0,0,0,384,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,81952,8392705,1073741824,131080,16777216,2147483648,469925904,16787458,2150105088,65552,41953281,4194944,671088640,0,0,0,0,4194304,134709304,58734595,2151153920,872693828,71320580,1081607232,1006911556,71320580,1078198272,1275347012,71320580,1078199360,1141129284,71320580,1078200256,1409564740,71320578,2151940736,1141129284,71320580,1078198272,1409564740,71320578,2151940736,1141129284,71320580,1078198528,1678032972,79711233,4456704,939802680,58734595,2151153664,1476608052,54539265,7864576,0,0,0,0,1,4194560,0,0,0,0,2,4194816,0,0,0,0,0,0,0,0,0,0,0,0
}; //1536 is the max resolution of PVZ2 textures
static Sexy::ImageFont* gsSysImageFont;

using namespace Sexy;

static void InitSysImageFont() //C++ only, TODO | 22-81
{
	if (gsSysImageFont == NULL)
		return;
	
	MemoryImage* anImage = new MemoryImage();
	anImage->Create(gs_font_image_width, gs_font_image_height);
	ulong* dst = anImage->GetBits();

	for (uint y = 0; y < gs_font_image_height; y++)
	{
		uint x = 0;
		for (int i = 0; i < gs_font_image_width_in_longs; i++)
		{
			ulong theLong = gs_font_image_data[i + gs_font_image_width_in_longs * y];
			for (int bit = 31; bit >= 0 && x < gs_font_image_width; bit--)
			{
				ulong thePixelColor = 0xFFFFFF; //Change?
				if ((theLong & (1 << bit)) != 0)
					thePixelColor = 0xFF;
				dst[x + gs_font_image_width * y] = thePixelColor;
				x++;
			}
		}
	}

	gsSysImageFont = new ImageFont(anImage);
	FontLayer* aFontLayer = &gsSysImageFont->mFontData->mFontLayerList.back();
	aFontLayer->mAscent = 5;
	aFontLayer->mHeight = gs_font_char_height;
	int anImageCharWidth = gs_font_char_width;
	int anImageCharHeight = gs_font_char_height;
	int anImageXOff = 1;
	int anImageYOff = 1;
	int xpos = 0;
	int ypos = 0;
	char aChar = 0;

	for (int j = 0; j < gs_font_image_height; j++)
	{
		xpos = 0;
		for (uint i = 0; i < gs_font_image_width_in_longs; i++)
		{
			CharData* aCharData = aFontLayer->mCharDataHashTable.GetCharData(aChar, true);
			aCharData->mImageRect = Rect(xpos, ypos, anImageCharWidth, anImageCharHeight);
			aCharData->mWidth = gs_font_char_data[16 * j + i];
			/*aCharData->mImageRect.mY = aCharData->mImageRect.mY;
			aCharData->mImageRect.mWidth = aCharData->mImageRect.mWidth;
			aCharData->mImageRect.mHeight = aCharData->mImageRect.mHeight;*/

			aCharData->mOffset = Point(-anImageXOff, anImageYOff);
			//aCharData->mOffset.mX = v5;
			//aCharData->mOffset.mY = mOffset.mY;
			xpos += anImageCharWidth;
			aChar++;
		}
		ypos += anImageCharHeight;
	}

	gsSysImageFont->GenerateActiveFontLayers();
	gsSysImageFont->mActiveListValid = true;
}

SysFont::SysFont(const std::string& theFace, int thePointSize, bool bold, bool italics, bool underline) //84-89
{
	InitSysImageFont();
	mImageFont = gsSysImageFont;

	InitFromImageFont();
}

SysFont::SysFont(SexyAppBase* theApp, const std::string& theFace, int thePointSize, int theScript, bool bold, bool italics, bool underline) //92-97
{
	InitSysImageFont();
	mImageFont = gsSysImageFont;

	InitFromImageFont();
}

SysFont::SysFont(const SysFont& theSysFont) //100-105
{
	InitSysImageFont();
	mImageFont = gsSysImageFont;

	InitFromImageFont();
}

SysFont::~SysFont() //108-110
{
	//?
}

void SysFont::InitFromImageFont() //113-118
{
	mHeight = mImageFont->mHeight;
	mAscent = mImageFont->mAscent;
	mAscentPadding = mImageFont->mAscentPadding;
	mLineSpacingOffset = mImageFont->mLineSpacingOffset;
}

ImageFont* SysFont::CreateImageFont() //121-123
{
	return mImageFont;
}

int	SysFont::StringWidth(const SexyString& theString) //126-128
{
	return mImageFont->StringWidth(theString);
}

void SysFont::DrawString(Graphics* g, int theX, int theY, const SexyString& theString, const Color& theColor, const Rect& theClipRect) //131-133
{
	mImageFont->DrawString(g, theX, theY, theString, theColor, theClipRect);
}

Font* SysFont::Duplicate() //136-138
{
	return new SysFont(*this);
}
